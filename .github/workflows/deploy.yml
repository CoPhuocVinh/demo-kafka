# ============================================
# Kafka Demo - CI/CD Pipeline
# ============================================
# Trigger: Push to main/master or manual dispatch
# Runner: Self-hosted on VPS
# ============================================

name: Deploy Kafka Demo

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'demo/**'
      - '.github/workflows/deploy.yml'
  
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'demo/**'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      rebuild_all:
        description: 'Rebuild all containers (including Kafka)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_DIR: ${{ vars.PROJECT_DIR || '~/kafka-demo' }}
  DOCKER_BUILDKIT: 1

jobs:
  # ============================================
  # Job 1: Lint & Test
  # ============================================
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # Backend lint & test
      - name: Install backend dependencies
        working-directory: demo/backend
        run: npm install
      
      - name: Lint backend
        working-directory: demo/backend
        run: npm run lint --if-present
      
      - name: Test backend
        working-directory: demo/backend
        run: npm run test --if-present
      
      # Frontend lint & test
      - name: Install frontend dependencies
        working-directory: demo/frontend
        run: npm install
      
      - name: Lint frontend
        working-directory: demo/frontend
        run: npm run lint --if-present
      
      - name: Build frontend
        working-directory: demo/frontend
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: demo/frontend/dist
          retention-days: 1

  # ============================================
  # Job 2: Build Docker Images
  # ============================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: lint-test
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: demo/backend
          push: false
          tags: kafka-demo-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: demo/frontend
          push: false
          tags: kafka-demo-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Job 3: Deploy to VPS
  # ============================================
  deploy:
    name: Deploy to VPS
    runs-on: self-hosted
    needs: build
    if: github.event_name != 'pull_request'
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ vars.APP_URL || 'http://localhost:8080' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show deployment info
        run: |
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ğŸ“ Project dir: ${{ env.PROJECT_DIR }}"
      
      - name: Sync project files
        run: |
          # Create project directory if not exists
          mkdir -p ${{ env.PROJECT_DIR }}
          
          # Sync demo folder
          rsync -av --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'dist' \
            --exclude '.env' \
            demo/ ${{ env.PROJECT_DIR }}/demo/
          
          echo "âœ… Files synced"
      
      - name: Create/Update .env file
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          # Create .env if not exists, preserve existing values
          if [ ! -f .env ]; then
            cp .env.example .env 2>/dev/null || touch .env
          fi
          
          # Update deployment timestamp
          if grep -q "LAST_DEPLOY=" .env; then
            sed -i "s/LAST_DEPLOY=.*/LAST_DEPLOY=$(date -Iseconds)/" .env
          else
            echo "LAST_DEPLOY=$(date -Iseconds)" >> .env
          fi
          
          echo "âœ… Environment file configured"
      
      - name: Pull latest Docker images
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          docker compose pull kafka-ui prometheus grafana || true
          echo "âœ… Images pulled"
      
      - name: Build application images
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          if [ "${{ github.event.inputs.rebuild_all }}" = "true" ]; then
            echo "ğŸ”¨ Rebuilding all images..."
            docker compose build --no-cache
          else
            echo "ğŸ”¨ Rebuilding app images only..."
            docker compose build --no-cache backend frontend
          fi
          echo "âœ… Images built"
      
      - name: Deploy with zero-downtime
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          echo "ğŸ“¤ Starting deployment..."
          
          # Check if Kafka is running
          if docker compose ps kafka-1 --format json 2>/dev/null | grep -q "running"; then
            echo "Kafka is running, performing rolling update..."
            
            # Update backend first
            docker compose up -d --no-deps backend
            sleep 5
            
            # Then frontend
            docker compose up -d --no-deps frontend
            sleep 3
            
            # Update monitoring if needed
            docker compose up -d --no-deps prometheus grafana kafka-ui
          else
            echo "Starting all services..."
            docker compose up -d
          fi
          
          echo "âœ… Containers updated"
      
      - name: Wait for services to be healthy
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          echo "â³ Waiting for services to be healthy..."
          
          # Wait for backend
          for i in {1..30}; do
            if curl -sf http://localhost:3000/metrics > /dev/null 2>&1; then
              echo "âœ… Backend is healthy"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          
          # Wait for frontend
          for i in {1..20}; do
            if curl -sf http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy"
              break
            fi
            echo "Waiting for frontend... ($i/20)"
            sleep 2
          done
      
      - name: Run health checks
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          echo "ğŸ¥ Running health checks..."
          
          HEALTH_OK=true
          
          # Check backend
          if curl -sf http://localhost:3000/metrics > /dev/null; then
            echo "âœ… Backend: OK"
          else
            echo "âŒ Backend: FAILED"
            HEALTH_OK=false
          fi
          
          # Check frontend
          if curl -sf http://localhost:8080 > /dev/null; then
            echo "âœ… Frontend: OK"
          else
            echo "âŒ Frontend: FAILED"
            HEALTH_OK=false
          fi
          
          # Check Kafka brokers
          for i in 1 2 3; do
            if docker exec kafka-$i /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server 127.0.0.1:9092 > /dev/null 2>&1; then
              echo "âœ… Kafka Broker $i: OK"
            else
              echo "âŒ Kafka Broker $i: FAILED"
              HEALTH_OK=false
            fi
          done
          
          if [ "$HEALTH_OK" = false ]; then
            echo ""
            echo "âš ï¸ Some services are unhealthy!"
            docker compose ps
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ All services are healthy!"
      
      - name: Show deployment summary
        if: always()
        working-directory: ${{ env.PROJECT_DIR }}/demo
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Deployment Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          docker compose ps
          echo ""
          echo "ğŸŒ Access URLs:"
          echo "   Frontend:  http://$(hostname -I | awk '{print $1}'):8080"
          echo "   Backend:   http://$(hostname -I | awk '{print $1}'):3000"
          echo "   Grafana:   http://$(hostname -I | awk '{print $1}'):3001"
          echo "   Kafka UI:  http://$(hostname -I | awk '{print $1}'):8081"
          echo ""
      
      - name: Cleanup old images
        if: success()
        run: |
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f --filter "until=24h" || true
          echo "âœ… Cleanup complete"

  # ============================================
  # Job 4: Notify on failure
  # ============================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint-test, build, deploy]
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "âŒ Deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          # Add your notification logic here (Slack, Discord, Email, etc.)
          # Example for Discord webhook:
          # curl -X POST -H "Content-Type: application/json" \
          #   -d '{"content": "âŒ Deployment failed for ${{ github.repository }}"}' \
          #   ${{ secrets.DISCORD_WEBHOOK_URL }}
