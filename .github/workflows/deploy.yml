# ============================================
# Kafka Demo - CI/CD Pipeline
# ============================================
# Trigger: Push to main/master or manual dispatch
# Runner: Self-hosted on VPS
# ============================================

name: Deploy Kafka Demo

on:
  push:
    branches:
      - main
      - master
  
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Rebuild all containers (including Kafka)'
        required: false
        default: false
        type: boolean

jobs:
  # ============================================
  # Job 1: Build & Test (on GitHub runner)
  # ============================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install & Build Backend
        working-directory: demo/backend
        run: |
          npm install
          npm run build --if-present
      
      - name: Install & Build Frontend
        working-directory: demo/frontend
        run: |
          npm install
          npm run build

  # ============================================
  # Job 2: Deploy to VPS (on self-hosted runner)
  # ============================================
  deploy:
    name: Deploy to VPS
    needs: build
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show deployment info
        run: |
          echo "ğŸš€ Deploying Kafka Demo"
          echo "ğŸ“¦ Commit: ${{ github.sha }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
      
      - name: Build and Deploy with Docker Compose
        working-directory: demo
        run: |
          # Build and start services
          if [ "${{ github.event.inputs.rebuild_all }}" = "true" ]; then
            echo "ğŸ”¨ Rebuilding all containers..."
            docker compose up --build -d
          else
            echo "ğŸ”¨ Rebuilding app containers only..."
            docker compose up --build -d backend frontend
            # Ensure other services are running
            docker compose up -d
          fi
      
      - name: Wait for services
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10
      
      - name: Health check
        working-directory: demo
        run: |
          echo "ğŸ¥ Running health checks..."
          
          # Check backend
          if curl -sf http://localhost:3000/metrics > /dev/null 2>&1; then
            echo "âœ… Backend: OK"
          else
            echo "âš ï¸ Backend: Starting..."
          fi
          
          # Check frontend
          if curl -sf http://localhost:8080 > /dev/null 2>&1; then
            echo "âœ… Frontend: OK"
          else
            echo "âš ï¸ Frontend: Starting..."
          fi
          
          # Show status
          docker compose ps
      
      - name: Show access URLs
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ Deployment Complete!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Access URLs:"
          IP=$(hostname -I | awk '{print $1}')
          echo "   Frontend:  http://$IP:8080"
          echo "   Backend:   http://$IP:3000"
          echo "   Grafana:   http://$IP:3001"
          echo "   Kafka UI:  http://$IP:8081"
          echo ""
